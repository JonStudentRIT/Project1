<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>430 Project 1</title>
    <script>
        let gameLoading = true;
        // the game board as the client understands
        let localBoard;
        // this players Identity
        let playerIndex = '0';
        // is this player the one who is making a move
        let thisPlayersMove = false;
        let cells = [];

        const handleResponse = async (response) => {
            const content = document.querySelector('#updateDisplay');
            const gameBoard = document.querySelector('#GameBoard');
            let obj = await response.json();
            // create a player or spectator
            if(response.status === 201)
            {
                if(playerIndex === '0')
                {
                    playerIndex = obj.message;
                    content.innerHTML = `${playerIndex}`;
                    if(playerIndex === '1')
                    {
                        thisPlayersMove = true;
                    }
                }
            }
            if (response.status === 200)
            {
                content.innerHTML = `${playerIndex} : ${thisPlayersMove}`;
                if(obj.player === true)
                {
                    //gameBoard.innerHTML = `player One Move`;
                    if(playerIndex === '1')
                    {
                        thisPlayersMove = true;
                    }
                }
                else
                {
                    //gameBoard.innerHTML = `player two Move`;
                    if(playerIndex === '2')
                    {
                        thisPlayersMove = true;
                    }
                }
                localBoard = obj.board;
                cells = localBoard.split(',');
                gameBoard.innerHTML = `${cells[0]} ${cells[1]} ${cells[2]} ${cells[3]}\n${cells[4]} ${cells[5]} ${cells[6]} ${cells[7]}\n${cells[8]} ${cells[9]} ${cells[10]} ${cells[11]}\n${cells[12]} ${cells[13]} ${cells[14]} ${cells[15]}\n`;
            }
        };
        const sendFetch = async (url) => {
            let response = await fetch(url);
            handleResponse(response);
        };
        const sendPost = async (cellIn) => {
            if(thisPlayersMove)
            {
                console.log(cells[12] + " " + typeof cells[12]);
                if(cellIn === 1)
                {
                    // col 1
                    if(cells[12] === '0')
                    {
                        cells[12] = playerIndex;
                    }
                    else if(cells[8] === '0')
                    {
                        cells[8] = playerIndex;
                    }
                    else if(cells[4] === '0')
                    {
                        cells[4] = playerIndex;
                    }
                    else if(cells[0] === '0')
                    {
                        cells[0] = playerIndex;
                    }
                    else
                    {
                        return;
                    }
                }
                // col 2
                if(cellIn === 2)
                {
                    if(cells[13] === '0')
                    {
                        cells[13] = playerIndex;
                    }
                    else if(cells[9] === '0')
                    {
                        cells[9] = playerIndex;
                    }
                    else if(cells[5] === '0')
                    {
                        cells[5] = playerIndex;
                    }
                    else if(cells[1] === '0')
                    {
                        cells[1] = playerIndex;
                    }
                    else
                    {
                        return;
                    }
                }
                //col 3
                if(cellIn === 3)
                {
                    if(cells[14] === '0')
                    {
                        cells[14] = playerIndex;
                    }
                    else if(cells[10] === '0')
                    {
                        cells[10] = playerIndex;
                    }
                    else if(cells[6] === '0')
                    {
                        cells[6] = playerIndex;
                    }
                    else if(cells[2] === '0')
                    {
                        cells[2] = playerIndex;
                    }
                    else
                    {
                        return;
                    }
                }
                // col 4
                if(cellIn === 4)
                {
                    if(cells[15] === '0')
                    {
                        cells[15] = playerIndex;
                    }
                    else if(cells[11] === '0')
                    {
                        cells[11] = playerIndex;
                    }
                    else if(cells[7] === '0')
                    {
                        cells[7] = playerIndex;
                    }
                    else if(cells[3] === '0')
                    {
                        cells[3] = playerIndex;
                    }
                    else
                    {
                        return;
                    }
                }
                let response = await fetch('/updateOut', {
                    method: 'post',
                    headers: {
                    //'Content-Type': 'application/x-www-form-urlencoded',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    },
                    body: `id=${playerIndex}&board=${cells[0]},${cells[1]},${cells[2]},${cells[3]},${cells[4]},${cells[5]},${cells[6]},${cells[7]},${cells[8]},${cells[9]},${cells[10]},${cells[11]},${cells[12]},${cells[13]},${cells[14]},${cells[15]}`
                });
                thisPlayersMove = false;
            }
        }
        
        const init = async () => {
            const col1 = document.querySelector('#col1');
            const col2 = document.querySelector('#col2');
            const col3 = document.querySelector('#col3');
            const col4 = document.querySelector('#col4');
            // assign this client a role
            sendFetch('/init');
            // get the initial board state
            // sendFetch('/getTick');
            
            
            
            col1.addEventListener('click', () => {sendPost(1)});
            col2.addEventListener('click', () => {sendPost(2)});
            col3.addEventListener('click', () => {sendPost(3)});
            col4.addEventListener('click', () => {sendPost(4)});
            // short polling at 5 sec
            setTimeout(function run() {
                setTimeout(run, 1000),
                sendFetch('/getTick')},
                1000);
        };
        window.onload = init;
        </script>
</head>
<body>
    <h1 id="updateDisplay">
---
    </h1>
    <button id="col1">1</button>
    <button id="col2">2</button>
    <button id="col3">3</button>
    <button id="col4">4</button>
    <h1 id="GameBoard">
---
    </h1>
</body>
</html>